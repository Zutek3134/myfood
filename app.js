class DataManagement { constructor(e) { this._validateDependencies(e), this.storageKeys = e.storageKeys, this.state = e.state, this.loadData = e.loadData, this.renderMealLogs = e.renderMealLogs, this.renderFavStores = e.renderFavStores, this.updatePopularItemsFromLogs = e.updatePopularItemsFromLogs, this.initAutoComplete = e.initAutoComplete, this.updateFilterDropdown = e.updateFilterDropdown, this.dom = e.domElements, this.getLocalDatetime = window.getLocalDatetime, this.pako = e.pako || window.pako, this._bindEvents() } _validateDependencies(e) { if (!e.storageKeys || !["MEALLOGS", "FAVSTORES", "POPULAR_ITEMS"].every((t => e.storageKeys[t]))) throw new Error("DataManagement 缺少必要的 storageKeys 配置（需包含 MEALLOGS/FAVSTORES/POPULAR_ITEMS）"); if (!e.state || "object" != typeof e.state) throw new Error("DataManagement 必須傳入 state 狀態物件"); if ("function" != typeof e.loadData) throw new Error("DataManagement 必須傳入 loadData 載入數據函式"); if ("function" != typeof e.renderMealLogs) throw new Error("DataManagement 必須傳入 renderMealLogs 渲染用餐紀錄函式"); if ("function" != typeof e.renderFavStores) throw new Error("DataManagement 必須傳入 renderFavStores 渲染餐廳函式"); if ("function" != typeof e.updatePopularItemsFromLogs) throw new Error("DataManagement 必須傳入 updatePopularItemsFromLogs 更新熱門菜品函式"); if ("function" != typeof e.updateFilterDropdown) throw new Error("DataManagement 必須傳入 updateFilterDropdown 更新篩選下拉選單函式"); if (!e.domElements || !["exportBtn", "importBtn", "fileInput"].every((t => e.domElements[t]))) throw new Error("DataManagement 缺少必要的 DOM 元素配置（需包含 exportBtn/importBtn/fileInput）") } _bindEvents() { this.dom.exportBtn.addEventListener("click", (() => this.exportDataCompressed())), this.dom.importBtn.addEventListener("click", (() => this.triggerImport())), this.dom.fileInput.addEventListener("change", (e => this.importData(e))), this.dom.deleteAll.addEventListener("click", (() => { confirm("確定刪除所有紀錄？") && (this.state.mealLogs = [], this.state.filteredMealLogs = [], this.saveToStorageWithCompression(this.storageKeys.mealLogs, this.state.mealLogs), this.updatePopularItemsFromLogs(), this.renderMealLogs()) })) } triggerImport() { this.dom.fileInput.value = "", this.dom.fileInput.click() } validateImportData(e) { return e && "object" == typeof e && Array.isArray(e.mealLogs) && Array.isArray(e.favStores) && "object" == typeof e.popularItems && null !== e.popularItems } saveToStorageWithCompression(e, t) { try { const a = Array.isArray(t) ? [] : {}, n = JSON.stringify(t ?? a), s = this.pako.gzip(n), o = btoa(String.fromCharCode.apply(null, s)); return localStorage.setItem(e, o), !0 } catch (e) { return console.error("壓縮儲存失敗：", e), window.showToast("數據儲存失敗，請重試"), !1 } } loadFromStorageWithCompression(e, t) { try { const a = localStorage.getItem(e); if (!a) return t; const n = new Uint8Array(atob(a).split("").map((e => e.charCodeAt(0)))), s = this.pako.ungzip(n, { to: "string" }); return JSON.parse(s) } catch (e) { return console.error("解壓縮讀取失敗：", e), window.showToast("數據讀取失敗，使用預設值"), t } } exportDataCompressed() { try { const e = { mealLogs: this.state.mealLogs || [], favStores: this.state.favStores || [], popularItems: this.state.popularItems || {} }, t = JSON.stringify(e), a = this.pako.gzip(t), n = new Blob([a], { type: "application/octet-stream" }), s = URL.createObjectURL(n), o = document.createElement("a"); o.href = s; const i = this.getLocalDatetime(), [r, l, d] = i.split("-"), m = parseInt(r, 10) - 1911, c = (new Date).toTimeString().slice(0, 5).replace(":", ""); o.download = `吃吃吃_${m}${l}${d}-${c}.myfood`, document.body.appendChild(o), o.click(), setTimeout((() => { document.body.removeChild(o), URL.revokeObjectURL(s) }), 100), window.showToast("成功匯出資料") } catch (e) { console.error("壓縮匯出失敗：", e), window.showToast("壓縮資料匯出失敗，請重試") } } importData(e) { const t = e.target.files[0]; if (!t) return; const a = new FileReader; a.onload = e => this.handleImportContent(e.target.result, t.name), a.onerror = () => window.showToast("檔案讀取失敗，請重試"), t.name.endsWith(".myfood") ? a.readAsArrayBuffer(t) : a.readAsText(t) } handleImportContent(e, t) { try { let a; if (t.endsWith(".myfood")) { const t = new Uint8Array(e), n = this.pako.ungzip(t, { to: "string" }); a = JSON.parse(n) } else if (this.isBase64(e)) { const t = new Uint8Array(atob(e).split("").map((e => e.charCodeAt(0)))), n = new TextDecoder("utf-8").decode(t); a = JSON.parse(n) } else a = JSON.parse(e); if (!this.validateImportData(a)) return void window.showToast("檔案格式不正確，請使用正確的備份檔案"); confirm("是否匯入資料？原紀錄將被覆蓋！") && (this.saveToStorageWithCompression(this.storageKeys.MEALLOGS, a.mealLogs || []), this.saveToStorageWithCompression(this.storageKeys.FAVSTORES, a.favStores || []), this.saveToStorageWithCompression(this.storageKeys.POPULAR_ITEMS, a.popularItems || {}), this.loadData(), this.renderMealLogs(), this.updatePopularItemsFromLogs(), this.initAutoComplete(), this.updateFilterDropdown(), window.showToast("成功匯入資料")) } catch (e) { console.error("匯入失敗：", e), window.showToast("檔案解析錯誤，請檢查檔案是否完好") } } isBase64(e) { if ("string" != typeof e || 0 === e.length) return !1; if (!/^[A-Za-z0-9+/]+={0,2}$/.test(e)) return !1; try { return btoa(atob(e)) === e } catch (e) { return !1 } } } class Dropdown { constructor() { this.init() } init() { document.querySelectorAll(".dropdown").forEach((e => { const t = e.querySelector(".dropdown-trigger"), a = e.querySelector("ul"); t.addEventListener("click", (t => { t.stopPropagation(), document.querySelectorAll(".dropdown").forEach((t => t !== e && t.classList.remove("open"))), e.classList.toggle("open") })), a.addEventListener("click", (n => { const s = n.target.closest("li"); if (!s) return; const { textContent: o } = s; t.querySelector("span:first-child").textContent = o, a.querySelectorAll("li").forEach((e => e.classList.remove("selected"))), s.classList.add("selected"), e.classList.remove("open"), e.dispatchEvent(new CustomEvent("change", { detail: { textContent: o } })) })) })), document.addEventListener("click", (() => { document.querySelectorAll(".dropdown").forEach((e => e.classList.remove("open"))) })) } create(e, t = !1) { const a = document.createElement("li"); return a.className = "" + (t ? "selected" : ""), a.textContent = e, a } update(e, t, a = !0) { a || (e.innerHTML = ""); const n = document.createDocumentFragment(); t.sort(((e, t) => window.compareBpmf(e, t))).forEach((e => { n.appendChild(this.create(e)) })), e.appendChild(n) } } class AutoComplete { constructor(e) { this.config = { inputElement: null, suggestionsContainer: null, dataSource: () => [], filterKey: "name", displayTemplate: e => e.name, onSelect: () => { }, debounceDelay: 50, ...e }, this.clickOutsideHandler = this.handleClickOutside.bind(this), this.init() } init() { const { inputElement: e, suggestionsContainer: t } = this.config; if (!e || !t) return void console.warn("Failed to initiate ACS: Missing required component."); e.autoCompleteInstance = this; const a = this.debounce((e => { const t = e.target.value; this.filterAndRender(t) }), this.config.debounceDelay); e.addEventListener("input", a), e.addEventListener("focus", (() => { this.filterAndRender(e.value) })), t.addEventListener("click", (t => { const a = t.target.closest(".auto-complete-suggestion"); if (a) { const t = a.dataset.value; e.value = t, this.hideSuggestions(), this.config.onSelect(t, a.dataset) } })), e.addEventListener("keydown", (e => this.handleKeyboard(e))), this.addClickOutsideListener() } addClickOutsideListener() { document.addEventListener("click", this.clickOutsideHandler, !0) } handleClickOutside(e) { const { inputElement: t, suggestionsContainer: a } = this.config, n = t.contains(e.target), s = a.contains(e.target); n || s || this.hideSuggestions() } filterAndRender(e) { const { dataSource: t, filterKey: a, suggestionsContainer: n, displayTemplate: s } = this.config, o = t(), i = e.trim().toLowerCase(), r = i ? o.filter((e => e[a]?.toLowerCase().includes(i))) : o.slice(0, 5); 0 !== r.length ? (n.innerHTML = r.map((e => `\n            <li class="auto-complete-suggestion" \n                 data-value="${e[a]}"\n                 data-${a}="${e[a]}">\n                ${s(e)}\n            </li>\n        `)).join(""), this.showSuggestions()) : this.hideSuggestions() } showSuggestions() { this.config.suggestionsContainer.parentElement.classList.add("open") } hideSuggestions() { this.config.suggestionsContainer.parentElement.classList.remove("open") } handleKeyboard(e) { const { suggestionsContainer: t, inputElement: a } = this.config, n = t.querySelectorAll(".auto-complete-suggestion"); if (0 === n.length) return; let s = Array.from(n).findIndex((e => e.classList.contains("active"))); switch (e.key) { case "ArrowDown": e.preventDefault(), s = s < n.length - 1 ? s + 1 : 0, this.setActiveSuggestion(n, s); break; case "ArrowUp": e.preventDefault(), s = s > 0 ? s - 1 : n.length - 1, this.setActiveSuggestion(n, s); break; case "Enter": e.preventDefault(), -1 !== s && n[s].click(); break; case "Escape": this.hideSuggestions() } } setActiveSuggestion(e, t) { e.forEach((e => e.classList.remove("active"))), e[t].classList.add("active"), e[t].scrollIntoView({ block: "nearest" }) } debounce(e, t) { let a; return (...n) => { clearTimeout(a), a = setTimeout((() => e.apply(this, n)), t) } } destroy() { const { inputElement: e } = this.config; e && (e.removeEventListener("input", this.handleInput), e.removeEventListener("focus", this.handleFocus), e.removeEventListener("keydown", this.handleKeyboard), delete e.autoCompleteInstance), document.removeEventListener("click", this.clickOutsideHandler, !0) } } class PanelManager { constructor() { this.currentOpenPanels = [], this.elements = { panelBackdrop: document.getElementById("panel-backdrop"), panelBackdropRaycast: document.getElementById("panel-backdrop-raycast") }, this.handleHashChange = e => { const t = e.newURL.includes("#panel-"); this.currentOpenPanels.length > 0 && !t && (e.preventDefault(), this.closeLastOpenPanel()) }, this.handleEscapeKey = e => { "Escape" === e.key && this.currentOpenPanels.length > 0 && (e.preventDefault(), this.closeLastOpenPanel()) }, window.addEventListener("hashchange", this.handleHashChange, !0), document.addEventListener("keydown", this.handleEscapeKey, !0) } openPanel(e) { const t = document.querySelector(`[data-panel="${e}"`); t.classList.remove("display-none"), t.parentElement.classList.add("show"), t.scrollTop = 0, this.elements.panelBackdrop.classList.add("show"), document.body.style.overflow = "hidden", this.currentOpenPanels.push(e); const a = `#${(new Date).getTime().toString().slice(5)}`, n = window.location.href.split("#")[0] + a; history.pushState({ panelId: e }, "", n) } closePanel(e) { const t = document.querySelector(`[data-panel="${e}"`); if (t.parentElement.classList.remove("show"), setTimeout((() => { t.classList.add("display-none") }), 300), this.currentOpenPanels = this.currentOpenPanels.filter((t => t !== e)), 0 === this.currentOpenPanels.length) { this.elements.panelBackdrop.classList.remove("show"), document.body.style.overflow = ""; const e = window.location.href.split("#")[0]; history.replaceState(null, "", e) } else this.elements.panelBackdrop.classList.add("show") } closeLastOpenPanel() { const e = this.currentOpenPanels.at(-1); e && this.closePanel(e) } closeAllPanels() { this.currentOpenPanels.forEach((e => this.closePanel(e))) } destroy() { window.removeEventListener("hashchange", this.handleHashChange, !0), document.removeEventListener("keydown", this.handleEscapeKey, !0) } } class MyFoodApp { constructor() { this.STORAGE_KEYS = { MEALLOGS: "foodDiaryMeals", FAVSTORES: "foodDiaryRestaurants", POPULAR_ITEMS: "foodDiaryPopularItems" }, this.dom = { moreMenu: { trigger: document.getElementById("more-menu-trigger"), expandMenu: document.getElementById("moreMenu"), backdrop: document.getElementById("moreMenu-backdrop"), themeSelectMenuItems: document.querySelectorAll("#theme-select-menu [data-theme]"), themeStylesheet: document.getElementById("colour-palette") }, filter: { toggle: document.getElementById("filter-toggle"), dropdown: document.querySelector('[data-type="dropdown"]'), date: { render: document.getElementById("filter-date-range-render"), range: document.getElementById("filter-date-range"), fp: null }, reset: document.getElementById("filter-reset"), apply: document.getElementById("filter-apply") }, exportImport: { exportBtn: document.getElementById("export-data"), importBtn: document.getElementById("import-data"), fileInput: document.getElementById("import-file"), deleteAll: document.getElementById("delete-data") }, mealLogs: { list: document.getElementById("mealLogs-list"), prompt: document.getElementById("mealLogs-prompt"), detail_panel: { id: "detail-mealLogs", obj: document.querySelector('[data-panel="detail-mealLogs"]'), image: document.querySelector('[data-panel="detail-mealLogs"] img'), title: document.querySelector('[data-panel="detail-mealLogs"] h2'), date: document.getElementById("detail-date"), cost: document.getElementById("detail-cost"), mealList: document.getElementById("detail-menu-items"), close: document.getElementById("detail-close"), actions: { copy: document.getElementById("detail-copy-btn"), edit: document.getElementById("detail-edit-btn"), delete: document.getElementById("detail-delete-btn") } }, add_panel: { id: "add-mealLogs", open: document.getElementById("open-mealLogs-panel"), obj: document.querySelector('[data-panel="add-mealLogs"]'), h2: document.querySelector('[data-panel="add-mealLogs"] h2'), form: document.querySelector('[data-panel="add-mealLogs"] form'), image: { preview: document.getElementById("image-preview"), uploadInput: document.getElementById("eaten-image-upload"), urlInput: document.getElementById("image-url"), loadUrlBtn: document.getElementById("load-image-url"), useDriveBtn: document.getElementById("convert-drive-url"), canvas: document.getElementById("canvasGenerator"), ctx: document.getElementById("canvasGenerator").getContext("2d") }, restaurant: { name: document.getElementById("eaten-restaurant-name"), nameACS: document.getElementById("eaten-restaurant-acs"), branch: document.getElementById("eaten-restaurant-branch"), branchACS: document.getElementById("eaten-branch-acs") }, date: { render: document.getElementById("eaten-date-render"), input: document.getElementById("eaten-date"), fp: null }, recommendationList: document.querySelector('[data-panel="add-mealLogs"] ul[data-type="eaten-recommendations-list"]'), eatenList: document.querySelector('[data-panel="add-mealLogs"] ul[data-type="eaten-list"]'), addEatenListItemBtn: document.querySelector('[data-panel="add-mealLogs"] .add-eaten-item'), eatenSum: document.getElementById("eaten-sum"), editMealId: document.getElementById("edit-meal-id"), close: document.getElementById("form-close"), save: document.querySelector('[data-panel="add-mealLogs"] .form-submit') } }, favStores: { list: document.getElementById("favStores-list"), prompt: document.getElementById("favStores-prompt"), add_panel: { id: "add-favStores", open: document.getElementById("open-favStores-panel"), obj: document.querySelector('[data-panel="add-favStores"]'), form: document.querySelector('[data-panel="add-favStores"] form'), restaurant: { name: document.getElementById("fav-restaurant-name"), branch: document.getElementById("fav-restaurant-branch") }, address: document.getElementById("fav-address"), recommendationList: document.querySelector('[data-panel="add-favStores"] ul[data-type="eaten-recommendations-list"]'), favList: document.querySelector('[data-panel="add-favStores"] ul[data-type="eaten-list"]'), addFavListItemBtn: document.querySelector('[data-panel="add-mealLogs"] ul[data-type="eaten-list"] .add-eaten-item') } } }, this.state = { mealLogs: [], filteredMealLogs: [], favStores: [], popularItems: {}, currentMealId: "", tempMealList: [] }, this.dropdown = new Dropdown, this.autoCompleteInstances = {}, this.debounceTimers = {}, this.dataManager = null, this.panelInstance = new PanelManager, this.init() } init() { this.initDataManagement(), this.updateFilterDropdown(), this.initAutoComplete(), this.bindEvents(), window.removeEatenListItem = this.removeEatenListItem.bind(this), document.querySelector(`[data-theme="${localStorage.getItem("selectedTheme") || "default"}"]`).click() } initDataManagement() { try { this.dataManager = new DataManagement({ storageKeys: this.STORAGE_KEYS, state: this.state, loadData: this.loadData.bind(this), renderMealLogs: this.renderMealLogs.bind(this), renderFavStores: this.renderFavStores.bind(this), updatePopularItemsFromLogs: this.updatePopularItemsFromLogs.bind(this), initAutoComplete: this.initAutoComplete.bind(this), updateFilterDropdown: this.updateFilterDropdown.bind(this), domElements: { exportBtn: this.dom.exportImport.exportBtn, importBtn: this.dom.exportImport.importBtn, fileInput: this.dom.exportImport.fileInput, deleteAll: this.dom.exportImport.deleteAll } }), this.loadData() } catch (e) { console.error("DataManagement 初始化失敗：", e), window.showToast("匯出匯入功能初始化失敗，請檢查配置") } } debounce(e, t, a = 150) { return (...n) => { this.debounceTimers[t] && clearTimeout(this.debounceTimers[t]), this.debounceTimers[t] = setTimeout((() => { e.apply(this, n) }), a) } } initAutoComplete() { const e = () => new Set(this.state.favStores.map((e => e.name.trim()))); this.autoCompleteInstances.mealRestaurant = new AutoComplete({ inputElement: this.dom.mealLogs.add_panel.restaurant.name, suggestionsContainer: this.dom.mealLogs.add_panel.restaurant.nameACS, dataSource: () => { const t = {}, a = {}, n = e(); return this.state.favStores.forEach((e => { const t = e.name.trim(); a[t] = (a[t] || 0) + 2 })), this.state.mealLogs.forEach((e => { const n = e.restaurant.trim(); a[n] = (a[n] || 0) + 1, t[n] = (t[n] || 0) + 1 })), Object.entries(a).map((([e, a]) => ({ name: e, count: t[e], score: a, isfavourite: n.has(e) }))).sort(((e, t) => t.score - e.score || window.compareBpmf(e.name, t.name))) }, filterKey: "name", displayTemplate: e => `\n                ${e.name}\n                ${e.isfavourite ? '<span class="favourite-badge"><span class="material-symbols-rounded">star</span></span>' : ""}\n                <span class="count-badge">${e.count} 次</span>\n            `, onSelect: e => { this.dom.mealLogs.add_panel.restaurant.branch.value = "", this.dom.mealLogs.add_panel.restaurant.branch.focus(), this.renderMenuRecommendations(e) } }), this.autoCompleteInstances.mealBranch = new AutoComplete({ inputElement: this.dom.mealLogs.add_panel.restaurant.branch, suggestionsContainer: this.dom.mealLogs.add_panel.restaurant.branchACS, dataSource: (e => () => { const t = e?.value.trim() || ""; if (!t) return []; const a = {}, n = {}; return this.state.favStores.filter((e => e.name.trim() === t.trim())).forEach((e => { const t = e.branch?.trim(); t && (n[t] = (n[t] || 0) + 2) })), this.state.mealLogs.filter((e => e.restaurant.trim() === t.trim())).forEach((e => { const t = e.branch?.trim(); t && (a[t] = (a[t] || 0) + 1, n[t] = (n[t] || 0) + 1) })), Object.entries(n).map((([e, t]) => ({ branch: e, count: a[e], score: t }))).sort(((e, t) => t.score - e.score || window.compareBpmf(e.name, t.name))) })(this.dom.mealLogs.add_panel.restaurant.name), filterKey: "branch", displayTemplate: e => `\n                ${e.branch}\n                <span class="count-badge">${e.count} 次</span>\n            ` }) } loadData() { this.state.mealLogs = this.dataManager.loadFromStorageWithCompression(this.STORAGE_KEYS.MEALLOGS, []), this.state.filteredMealLogs = [...this.state.mealLogs], this.state.favStores = this.dataManager.loadFromStorageWithCompression(this.STORAGE_KEYS.FAVSTORES, []), this.state.popularItems = this.dataManager.loadFromStorageWithCompression(this.STORAGE_KEYS.POPULAR_ITEMS, {}), this.sortMealsByDate(), this.renderMealLogs(), this.renderFavStores(), this.initDatePicker() } initDatePicker() { var e, t; e = this, t = function (e) { var t = "undefined" != typeof window && void 0 !== window.flatpickr ? window.flatpickr : { l10ns: {} }, a = { weekdays: { shorthand: ["日", "一", "二", "三", "四", "五", "六"], longhand: ["週日", "週一", "週二", "週三", "週四", "週五", "週六"] }, months: { shorthand: ["1 月", "2 月", "3 月", "4 月", "5 月", "6 月", "7 月", "8 月", "9 月", "10 月", "11 月", "12 月"], longhand: ["1 月", "2 月", "3 月", "4 月", "5 月", "6 月", "7 月", "8 月", "9 月", "10 月", "11 月", "12 月"] }, rangeSeparator: " 至 ", weekAbbreviation: "週", scrollTitle: "滾動切換", toggleTitle: "點擊切換 12 / 24 小時時制" }; t.l10ns.zh_tw = a; var n = t.l10ns; e.MandarinTraditional = a, e.default = n, Object.defineProperty(e, "__esModule", { value: !0 }) }, "object" == typeof exports && "undefined" != typeof module ? t(exports) : "function" == typeof define && define.amd ? define(["exports"], t) : t((e = "undefined" != typeof globalThis ? globalThis : e || self)["zh-tw"] = {}), flatpickr.localize(flatpickr.l10ns.zh_tw), this.dom.mealLogs.add_panel.date.fp = flatpickr(this.dom.mealLogs.add_panel.date.input, { enableTime: !0, noCalendar: !1, minuteIncrement: 1, dateFormat: "Y-m-d H:i", time_24hr: !0, defaultDate: new Date, disableMobile: !0, maxDate: (new Date).fp_incr(1), disable: [(new Date).fp_incr(1)], onChange: e => { const t = e[0]; if (!t) return; const a = window.formatDate(t), n = String(t.getHours()).padStart(2, "0"), s = String(t.getMinutes()).padStart(2, "0"); this.dom.mealLogs.add_panel.date.render.value = `${a}   ${n} : ${s}` } }), this.createEventDots() } createEventDots() { const e = this.state.mealLogs.map((e => flatpickr.formatDate(new Date(e.date), "Y-m-d"))), t = e.pop(), a = e.shift(); this.dom.filter.date.fp = flatpickr(this.dom.filter.date.range, { mode: "range", enableTime: !1, noCalendar: !1, dateFormat: "Y-m-d", defaultDate: [t, a], disableMobile: !0, minDate: t, maxDate: (new Date).fp_incr(1), disable: [(new Date).fp_incr(1)], onChange: e => { const t = []; let a, n; e.forEach((e => { const s = [], o = window.formatDate(e).split(" / "); o[0] != a && s.push(o[0]), o[1] != n && s.push(o[1]), s.push(o[2]), t.push(s.join(" / ")), a = o[0], n = o[1] })), this.dom.filter.date.render.value = t.join(" ⸺ ") }, onDayCreate: function (a, n, s, o) { const i = s.formatDate(o.dateObj, "Y-m-d"); (e.includes(i) || i === t) && (o.innerHTML += "<span class='event'></span>") } }), this.dom.filter.date.fp.setDate() } sortMealsByDate() { this.state.mealLogs.sort(((e, t) => t.date.localeCompare(e.date))) } renderMealLogs() { if (this.dom.mealLogs.list.innerHTML = "", 0 === this.state.filteredMealLogs.length) return void this.dom.mealLogs.prompt.classList.remove("display-none"); this.dom.mealLogs.prompt.classList.add("display-none"); const e = document.createDocumentFragment(); this.state.filteredMealLogs.forEach(((t, a) => { e.appendChild(this.createMealCard(t, a)) })), this.dom.mealLogs.list.appendChild(e) } createMealCard(e, t) { const a = document.createElement("li"); a.dataset.id = e.id, a.style.animationDelay = .1 * t + "s"; const n = e.menu.map(((e, t) => `<span class="menu-item-tag" style="animation-delay: ${.1 + .05 * t}s">${e.name}</span>`)).join(""); return a.innerHTML = `\n                <div class="cover">\n                    <div class="badge">${e.restaurant}${e.branch ? "・" + e.branch : ""}</div>\n                    <img src="${e.img}" alt="${e.restaurant}">\n                </div>\n                <div class="body">\n                    <h3>\n                        <span class="material-symbols-rounded">event</span>${window.formatDate(e.date)}\n                    </h3>\n                    <div class="menu-preview">${n}</div>\n                    <div class="footer">\n                        <span>${e.menu.length} 道菜</span>\n                        <span class="totalCost">$ ${e.totalCost.toLocaleString()}</span>\n                    </div>\n                </div>\n            `, a.addEventListener("click", (() => this.showMealDetail(e))), a } showMealDetail(e) { this.state.currentMealId = e.id, this.dom.mealLogs.detail_panel.image.src = e.img, this.dom.mealLogs.detail_panel.title.innerHTML = `${e.restaurant}<sub>${e.branch || ""}</sub>`, this.dom.mealLogs.detail_panel.date.textContent = `${window.formatDate(e.date)}`, this.dom.mealLogs.detail_panel.cost.textContent = `$ ${e.totalCost.toLocaleString()}`, this.dom.mealLogs.detail_panel.cost.style.animationDelay = .05 * (e.menu.length + 8) + "s", this.dom.mealLogs.detail_panel.mealList.innerHTML = ""; const t = document.createDocumentFragment(); e.menu.forEach(((e, a) => { e.amount || (e.amount = 1), e.note || (e.note = ""); const n = document.createElement("div"); n.className = "menu-item", n.style.opacity = "0", n.style.transform = "translateY(10px)", n.style.animation = "fadeIn 0.3s ease forwards", n.style.animationDelay = .05 * (a + 8) + "s", n.innerHTML = `\n                    <span data-type="name">${e.name}<span data-type="amount">${e.amount > 1 ? e.amount : ""}</span></span>\n                    <span data-type="price">${(e.price * e.amount).toLocaleString()}</span>\n                    <span data-type="note">${e.note}</span>\n                `, t.appendChild(n) })), this.dom.mealLogs.detail_panel.mealList.appendChild(t), this.panelInstance.openPanel(this.dom.mealLogs.detail_panel.id) } resetMealLogsPanel() { const e = this.dom.mealLogs.add_panel; e.form.reset(), e.editMealId.value = "", e.eatenList.innerHTML = "", this.addEatenListItem({ silent: !0 }), e.image.preview.innerHTML = '<span class="material-symbols-rounded upload-icon">add_photo_alternate</span>', e.image.urlInput.value = "", e.recommendationList.innerHTML = "", this.calcEatenListSum(), e.obj.querySelectorAll(".form-group.error").forEach((e => e.classList.remove("error"))), this.dom.mealLogs.add_panel.date.fp.clear(), this.dom.mealLogs.add_panel.date.fp.setDate(`${window.getLocalDatetime(!0).replace("T", " ")}`, !0), this.state.tempMealList = [] } createEatenListItem(e) { const t = document.createElement("li"); return t.innerHTML = `\n<div class="form-group">\n    <label>名稱</label>\n    <input type="text" data-type="name" placeholder="菜品" required>\n    <div class="form-error">請輸入菜品名稱</div>\n</div>\n<div class="form-group">\n    <label>單價</label>\n    <input type="number" data-type="price" step="1" placeholder="單價" required>\n    <div class="form-error">請輸入單價</div>\n</div>\n<div class="form-group">\n    <label>詳細備注（選填）</label>\n    <input type="text" data-type="note" placeholder="備注（選填）">\n</div>\n<div class="form-group">\n    <label>數量</label>\n    <input type="number" data-type="amount" min="1" step="1" placeholder="數量" value="1" required>\n    <div class="form-error">請輸入有效數量</div>\n</div>\n<button type="button" class="remove-eaten-item btn-danger" onclick="removeEatenListItem(this, ${e})"><span class="material-symbols-rounded" style="font-size:1.25em;">delete</span></button>\n`, t.style.opacity = "0", t.style.transform = "translateY(10px)", setTimeout((() => { t.style.transition = "opacity 0.3s ease, transform 0.3s ease", t.style.opacity = "1", t.style.transform = "translateY(0)" }), 10), t } addEatenListItem(e = {}) { const { isRestaurantMenu: t = !1, silent: a = !1 } = e, n = t ? this.dom.favStores.add_panel.eatenList : this.dom.mealLogs.add_panel.eatenList; n && (n.appendChild(this.createEatenListItem(t)), a || t || this.calcEatenListSum()) } removeEatenListItem(e, t) { e.parentElement.remove(), t || this.calcEatenListSum() } calcEatenListSum() { let e = 0; return this.dom.mealLogs.add_panel.eatenList.querySelectorAll("li").forEach((t => { const a = parseInt(t.querySelector('input[data-type="amount"]').value.trim() || 1), n = parseInt(t.querySelector('input[data-type="price"]').value.trim() || 0) * a; e += n })), this.dom.mealLogs.add_panel.eatenSum.value = e.toLocaleString(), e } saveMealLog() { if (!(() => { let e = !0; for (const t of this.dom.mealLogs.add_panel.obj.querySelectorAll("input[required]")) { const a = t.value.trim(); if ("number" === t.type ? (e = !(!a || isNaN(a)), t.max && (e = a <= t.max), t.min && (e = a >= t.min)) : e = !!a, t.closest(".form-group").classList.toggle("error", !e), !e) break } return e })()) return void window.showToast("表單填寫有誤，請檢查"); const e = this.dom.mealLogs.add_panel.editMealId.value, t = !!e, a = this.dom.mealLogs.add_panel.restaurant.name.value.trim(), n = this.dom.mealLogs.add_panel.restaurant.branch.value.trim(), s = this.dom.mealLogs.add_panel.date.input.value + ":" + ("0" + (new Date).getSeconds()).slice(-2), o = []; if (this.dom.mealLogs.add_panel.eatenList.querySelectorAll("li").forEach((e => { const t = e.querySelector('input[data-type="name"]').value.trim(), a = parseInt(e.querySelector('input[data-type="amount"]').value.trim()), n = parseInt(e.querySelector('input[data-type="price"]').value.trim() || 0), s = e.querySelector('input[data-type="note"]').value.trim() || ""; o.push({ name: t, price: n, note: s, amount: a }) })), 0 === o.length) return void window.showToast("請至少添加 1 道菜品"); const i = this.calcEatenListSum(); let r = this.dom.mealLogs.add_panel.image.preview.firstChild.src; if (r || (r = this.drawTextOnCanvas(a)), t) { const t = this.state.mealLogs.findIndex((t => t.id === e)); -1 !== t && (this.state.mealLogs[t] = { ...this.state.mealLogs[t], restaurant: a, branch: n, date: s, menu: o, totalCost: i, img: r }) } else this.state.mealLogs.push({ id: window.generateId(), restaurant: a, branch: n, date: s, menu: o, totalCost: i, img: r }); this.sortMealsByDate(), this.state.filteredMealLogs = [...this.state.mealLogs], this.applyFilter(), this.dataManager.saveToStorageWithCompression(this.STORAGE_KEYS.MEALLOGS, this.state.mealLogs), this.renderMealLogs(), this.updateFilterDropdown(), this.createEventDots(), this.panelInstance.closePanel(this.dom.mealLogs.add_panel.id), this.resetMealLogsPanel(), window.showToast(t ? "成功更新" : "成功儲存") } copyOrEditMealLog(e = !1) { const t = this.state.mealLogs.find((e => e.id === this.state.currentMealId)), a = this.dom.mealLogs.add_panel; a.editMealId.value = e ? "" : this.state.currentMealId, a.h2.textContent = (e ? "複製" : "編輯") + "用餐紀錄", a.restaurant.name.value = t.restaurant, a.restaurant.branch.value = t.branch, a.date.fp.setDate(e ? window.getLocalDatetime(!0) : t.date, !0), this.fillMenuItems(t.menu), this.displayImage(t.img), a.image.urlInput.value = t.img, this.calcEatenListSum(), this.panelInstance.closePanel(this.dom.mealLogs.detail_panel.id), setTimeout((() => { this.panelInstance.openPanel(a.id) }), 300), this.state.currentMealId = null } fillMenuItems(e, t) { t ? this.d0m.frequentRestaurantMenuItems.innerHTML = "" : this.dom.mealLogs.add_panel.eatenList.innerHTML = "", e.forEach(((e, a) => { this.addEatenListItem(!0, t); const n = t ? this.elements.frequentRestaurantMenuItems : this.dom.mealLogs.add_panel.eatenList.lastChild;["name", "price", "note", "amount"].forEach((t => { const a = n.querySelector(`input[data-type="${t}"]`); let s = e[t]; if (!s) switch (t) { case "note": s = ""; break; case "amount": s = 1; break; case "price": s = 0; break; default: return }a.value = s })) })) } renderFavStores() { this.dom.favStores.prompt.classList.remove("display-none") } updatePopularItemsFromLogs() { const e = {}; this.state.mealLogs.forEach((t => { t.menu?.forEach((t => { const a = t.name?.trim(); a && (e[a] ? (e[a].count += 1, e[a].avgPrice = Math.round((e[a].avgPrice * (e[a].count - 1) + (t.price || 0)) / e[a].count)) : e[a] = { count: 1, avgPrice: t.price || 0, note: t.note || "" }) })) })), this.state.popularItems = e, this.dataManager.saveToStorageWithCompression(this.STORAGE_KEYS.POPULAR_ITEMS, e) } updateFilterDropdown() { const e = document.querySelector('#filter-section ul[data-type="dropdown"]'); this.dropdown.update(e, ["所有​餐廳"], !1), this.dropdown.update(e, Array.from(new Set([...this.state.favStores.map((e => e.name)), ...this.state.mealLogs.map((e => e.restaurant))]))) } applyFilter() { let e = this.dom.filter.dropdown.querySelector("li.selected")?.textContent.replace("所有​餐廳", ""); const t = new Date(this.dom.filter.date.fp.selectedDates[0] || 0), a = new Date(this.dom.filter.date.fp.selectedDates[1] || ""); this.state.filteredMealLogs.length != this.state.mealLogs.length && (this.state.filteredMealLogs = [...this.state.mealLogs]), this.state.filteredMealLogs = this.state.mealLogs.filter((n => { const s = new Date(n.date); return (!e || n.restaurant === e) && (!(t && s < t) && !(a && s > a)) })), this.state.filteredMealLogs.sort(((e, t) => t.date - e.date)), this.renderMealLogs() } drawTextOnCanvas(e) { const t = 711, a = this.dom.mealLogs.add_panel.image.ctx, n = this.dom.mealLogs.add_panel.image.canvas; a.clearRect(0, 0, t, 400); const s = { lightBgTextColors: ["#1a202c", "#2d3748", "#4a5568", "#2b6cb0", "#2f855a", "#9f7aea", "#c53030", "#d69e2e"], darkBgTextColors: ["#f7fafc", "#edf2f7", "#e8f4f8", "#f0f8fb", "#f5fafe", "#fdf2f8", "#faf6ed", "#eaf6fa"] }, o = e => { const t = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e); return t ? { r: parseInt(t[1], 16), g: parseInt(t[2], 16), b: parseInt(t[3], 16) } : null }, i = e => { const t = [e.r, e.g, e.b].map((e => { const t = e / 255; return t <= .03928 ? t / 12.92 : Math.pow((t + .055) / 1.055, 2.4) })); return .2126 * t[0] + .7152 * t[1] + .0722 * t[2] }, r = (() => { let e = ""; for (let t = 0; t < 6; t++)e += "0123456789ABCDEF"[Math.floor(16 * Math.random())]; return e })(), l = (e => { const t = o(`#${e}`), a = i(t), n = (a > .5 ? s.lightBgTextColors : s.darkBgTextColors).filter((e => { const a = o(e); return ((e, t) => { const a = i(e), n = i(t); return (Math.max(a, n) + .05) / (Math.min(a, n) + .05) })(t, a) >= 4.5 })); return n.length > 0 ? n[Math.floor(Math.random() * n.length)] : a > .5 ? "#000" : "#fff" })(r); a.fillStyle = "#" + r, a.fillRect(0, 0, t, 400); const d = e.split("\n").filter((e => "" !== e.trim())), m = d.length > 0 ? d : ["*餐點照片*"]; a.fillStyle = l, a.textAlign = "center", a.textBaseline = "middle", a.font = '60px "NotoSans", "ZutekSans", sans-serif', a.shadowColor = "rgba(0, 0, 0, 0.15)", a.shadowBlur = 3, a.shadowOffsetX = 0, a.shadowOffsetY = 0; const c = (400 - 75 * m.length) / 2 + 37.5; return m.forEach((e => { let t = 60; for (; a.measureText(e).width > 604.35 && t > 16;)t--, a.font = `${t}px "NotoSans", "ZutekSans", sans-serif` })), m.forEach(((e, t) => { const n = c + 75 * t; a.fillText(e, 355.5, n) })), a.shadowColor = "transparent", n.toDataURL("image/png") } displayImage(e) { this.dom.mealLogs.add_panel.image.preview.innerHTML = ""; const t = document.createElement("img"); t.src = e, t.alt = "餐點照片", t.onerror = () => { this.dom.mealLogs.add_panel.image.preview.innerHTML = '<span class="material-symbols-rounded upload-icon">error</span>', this.showToast("圖片載入失敗，請更換圖片或 URL"), this.state.currentImageData = null }, t.onload = () => { this.dom.mealLogs.add_panel.image.urlInput.value = e }, this.dom.mealLogs.add_panel.image.preview.appendChild(t) } bindEvents() { document.querySelectorAll(".tab-item").forEach((e => { e.addEventListener("click", (function () { document.querySelectorAll(".tab-item").forEach((e => e.classList.remove("active"))), this.classList.add("active"); const e = this.dataset.tab, t = document.getElementById("mealLogs-record").parentElement, a = document.getElementById("favStores-records").parentElement; if (t && a) { const n = "mealList" === e; t.classList.toggle("display-none", !n), a.classList.toggle("display-none", n) } })) })), this.dom.moreMenu.trigger.addEventListener("click", (() => { this.dom.moreMenu.expandMenu.classList.toggle("open"), this.dom.moreMenu.backdrop.classList.toggle("show") })), this.dom.moreMenu.backdrop.addEventListener("click", (() => { this.dom.moreMenu.expandMenu.classList.toggle("open", !1), this.dom.moreMenu.backdrop.classList.toggle("show", !1) })), this.dom.moreMenu.themeSelectMenuItems.forEach((e => e.addEventListener("click", (e => { const t = e.target.dataset.theme; localStorage.setItem("selectedTheme", t), this.dom.moreMenu.themeSelectMenuItems.forEach((e => { e.classList.contains("selected") && e.classList.remove("selected") })), e.target.classList.add("selected"), this.dom.moreMenu.themeStylesheet.setAttribute("href", `palettes/${t}.css`) })))), this.dom.filter.toggle.addEventListener("click", (() => { this.dom.filter.toggle.parentElement.classList.toggle("expanded") })), this.dom.filter.date.render.addEventListener("click", (() => this.dom.filter.date.range.click())), this.dom.filter.apply.addEventListener("click", (() => this.applyFilter())), this.dom.filter.reset.addEventListener("click", (() => { this.dom.filter.dropdown.firstChild.click(), this.dom.filter.date.fp.setDate([], !0), this.applyFilter() })), this.panelInstance.elements.panelBackdropRaycast.addEventListener("click", (() => this.panelInstance.closeAllPanels())), this.dom.mealLogs.detail_panel.close.addEventListener("click", (() => this.panelInstance.closePanel(this.dom.mealLogs.detail_panel.id))), this.dom.mealLogs.detail_panel.actions.copy.addEventListener("click", (() => this.copyOrEditMealLog(!0))), this.dom.mealLogs.detail_panel.actions.edit.addEventListener("click", (() => this.copyOrEditMealLog())), this.dom.mealLogs.detail_panel.actions.delete.addEventListener("click", (() => { confirm("確定刪除？") && (this.state.mealLogs = this.state.mealLogs.filter((e => e.id !== this.state.currentMealId)), this.state.filteredMealLogs = this.state.filteredMealLogs.filter((e => e.id !== this.state.currentMealId)), this.dataManager.saveToStorageWithCompression(this.STORAGE_KEYS.MEALLOGS, this.state.mealLogs), this.updatePopularItemsFromLogs(), this.renderMealLogs(), window.showToast("成功刪除"), this.panelInstance.closePanel(this.dom.mealLogs.detail_panel.id)) })), this.dom.mealLogs.add_panel.close.addEventListener("click", (() => this.panelInstance.closePanel(this.dom.mealLogs.add_panel.id))), this.dom.mealLogs.add_panel.date.render.addEventListener("click", (() => this.dom.mealLogs.add_panel.date.input.click())), this.dom.mealLogs.add_panel.open.addEventListener("click", (() => { this.dom.mealLogs.add_panel.h2.textContent = "新增用餐紀錄", this.resetMealLogsPanel(), this.panelInstance.openPanel(this.dom.mealLogs.add_panel.id) })), this.dom.mealLogs.add_panel.eatenList.addEventListener("input", (e => { "price" !== e.target.dataset.type && "amount" !== e.target.dataset.type || this.calcEatenListSum() })), this.dom.mealLogs.add_panel.addEatenListItemBtn.addEventListener("click", (() => this.addEatenListItem())), this.dom.mealLogs.add_panel.save.addEventListener("click", (() => this.saveMealLog())), this.dom.mealLogs.add_panel.image.uploadInput.addEventListener("change", (e => { const t = e.target.files[0]; if (t) { const e = new FileReader; e.onload = e => this.displayImage(e.target.result), e.readAsDataURL(t) } })), this.dom.mealLogs.add_panel.image.preview.addEventListener("click", (() => { this.dom.mealLogs.add_panel.image.uploadInput.click() })), this.dom.mealLogs.add_panel.image.loadUrlBtn.addEventListener("click", (() => { const e = this.dom.mealLogs.add_panel.image.urlInput.value.trim(); e ? e.startsWith("http://") || e.startsWith("https://") || e.startsWith("data:image/png;base64,") ? this.displayImage(e) : window.showToast("請輸入有效的圖片 URL") : window.showToast("請輸入圖片 URL") })), this.dom.mealLogs.add_panel.image.useDriveBtn.addEventListener("click", (() => { const e = this.dom.mealLogs.add_panel.image.urlInput.value.trim(); if (!e) return void window.showToast("請輸入圖片 URL"); const t = e.split("?")[0].replace("https://drive.google.com/file/d/", "").replace("/view", ""); this.displayImage("https://lh3.googleusercontent.com/d/" + t) })), this.dom.favStores.add_panel.open.addEventListener("click", (() => { window.showToast("敬請期待") })) } } document.addEventListener("DOMContentLoaded", (() => { window.bpmfCollator = new Intl.Collator("zh-Hant", { collation: "zhuyin" }), window.compareBpmf = (e, t) => window.bpmfCollator.compare(e, t), window.getLocalDatetime = (e = !1) => { const t = new Date, a = function (e, t = 2) { return String(e).padStart(t, "0") }, n = t.getFullYear(), s = a(t.getMonth() + 1), o = a(t.getDate()); if (!e) return `${n}-${s}-${o}`; return `${n}-${s}-${o}T${a(t.getHours())}:${a(t.getMinutes())}:${a(t.getSeconds())}` }, window.formatDate = (e, t = !1) => { const a = new Date(e).toLocaleDateString("zh-TW", { year: "numeric", month: "numeric", day: "2-digit", weekday: "short" }).split("/"); return a[0] -= 1911, t || (a[2] = a[2].split("（")[0]), a.join(" / ") }, window.showToast = e => { const t = document.createElement("div"); t.className = "toast-notification", t.textContent = e, document.body.appendChild(t), setTimeout((() => t.classList.add("show")), 10), setTimeout((() => { t.classList.remove("show"), setTimeout((() => t.remove()), 300) }), 3e3) }, window.generateId = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 7), new MyFoodApp }));